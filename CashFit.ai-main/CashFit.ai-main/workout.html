<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CashFit.ai - Workout</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&family=Roboto:wght@300;400;500&family=Poppins:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.19.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@0.0.6"></script>
    <meta name="theme-color" content="#FF7B2D">
    <link rel="icon" type="image/x-icon" href="logo.png">
    <style>
        :root {
            --primary: #FF7B2D;
            --primary-light: #FF9D5C;
            --primary-dark: #E65F00;
            --secondary: #333333;
            --light-gray: #f5f5f5;
            --white: #ffffff;
            --text: #2D2D2D;
            --border: #e0e0e0;
            --error: #E74C3C;
            --success: #27AE60;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            color: var(--text);
            background-color: var(--light-gray);
            line-height: 1.6;
        }
        
        h1, h2, h3, h4, h5 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
        }
        
        .workout-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .workout-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .header-left {
            flex: 1;
            min-width: 250px;
        }
        
        .page-title {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .challenge-info {
            font-size: 1rem;
            color: #777;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        ::selection {
      background: var(--primary);
      color: var(--white);
    }
        
        .btn {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 50px;
            text-decoration: none;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-secondary {
            background-color: var(--white);
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        
        .btn-secondary:hover {
            background-color: rgba(255, 123, 45, 0.1);
        }
        
        .camera-container {
            background-color: var(--white);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            position: relative;
        }
        
        .camera-placeholder {
            width: 100%;
            height: 400px;
            background-color: #000;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--white);
            font-size: 1.2rem;
            position: relative;
        }
        
        .camera-error {
            color: var(--error);
            padding: 10px;
            border-radius: 5px;
            background-color: rgba(231, 76, 60, 0.1);
            margin-top: 10px;
            display: none;
        }
        
        #webcam {
            width: 100%;
            height: 100%;
            border-radius: 10px;
            object-fit: cover;
            transform: scaleX(-1); 
            filter: blur(12px);
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 10px;
            transform: scaleX(-1); 
        }
        
        .camera-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .exercise-info {
            display: flex;
            flex-direction: column;
            background-color: var(--white);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }
        
        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .exercise-title {
            font-size: 1.5rem;
        }
        
        .exercise-count {
            background-color: var(--primary);
            color: var(--white);
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        .exercise-instructions {
            margin-bottom: 20px;
        }
        
        .instruction-title {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        .instruction-steps {
            padding-left: 20px;
        }
        
        .instruction-step {
            margin-bottom: 8px;
        }
        
        .progress-container {
            margin-top: 15px;
        }
        
        .progress-title {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #eee;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--primary);
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .form-feedback {
            background-color: var(--secondary);
            color: var(--white);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            opacity: 0.9;
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .form-correct {
            background-color: var(--success);
        }
        
        .form-incorrect {
            background-color: var(--error);
        }
        
        .workout-summary {
            display: none;
            background-color: var(--white);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .summary-header {
            margin-bottom: 20px;
        }
        
        .summary-title {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .summary-subtitle {
            font-size: 1.1rem;
            color: #777;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-stat {
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 10px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #777;
        }
        
        .summary-message {
            margin-bottom: 30px;
            padding: 20px;
            background-color: rgba(255, 123, 45, 0.1);
            border-radius: 10px;
        }
        
        .verification-info {
            font-size: 0.9rem;
            color: #777;
            margin-bottom: 20px;
        }
        
        .bottom-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .status-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 15px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--white);
            background-color: var(--secondary);
            z-index: 1000000;
            margin-top: 10px;
            margin-right: 10px;
        }
        
        .recording .status-indicator {
            background-color: var(--error);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }
        
        .info-badge {
            display: inline-flex;
            align-items: center;
            font-size: 0.8rem;
            color: #777;
            background-color: #f0f0f0;
            padding: 4px 12px;
            border-radius: 50px;
            margin-left: 10px;
        }
        
        .info-badge i {
            margin-right: 5px;
            font-size: 0.9rem;
        }
        
        .counter-container {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
        }
        
        .counter-container i {
            margin-right: 8px;
        }
        
        
        .spinner {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .loading-text {
            margin-top: 15px;
            font-size: 1rem;
            color: var(--white);
        }

        @media (max-width: 768px) {
            .workout-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .dbc{
                display: none;
            }
            
            .header-actions {
                margin-top: 15px;
            }
            
            .camera-placeholder {
                height: 300px;
            }
            
            .exercise-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .camera-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .camera-controls .btn {
                width: 100%;
                text-align: center;
            }
            
            .summary-stats {
                grid-template-columns: 1fr 1fr;
            }

            .upload-btn{
            display: none;
        }
        }


        
        .exercise-dropdown {
            padding: 10px 15px;
            border-radius: 50px;
            border: 1px solid var(--border);
            font-family: 'Roboto', sans-serif;
            background-color: var(--white);
            color: var(--text);
            cursor: pointer;
            font-size: 0.9rem;
            margin-right: 10px;
        }
        
        .upload-btn {
            position: relative;
            overflow: hidden;
        }
        
        #uploaded-video-container {
            display: none;
            position: relative;
            width: 100%;
            height: 400px;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }
        
        #uploaded-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        #uploaded-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .timer-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 700;
        }
        
        @media (max-width: 768px) {
            .exercise-dropdown {
                width: 100%;
                margin-bottom: 10px;
                margin-right: 0;
            }
        }

        #toggle-blur-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100000000;         
        }

        .blockchain-upload-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85);
            border-radius: 15px;
            padding: 20px;
            max-width: 400px;
            width: 80%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            text-align: center;
            backdrop-filter: blur(5px);
            display: none;
        }

        .blockchain-upload-title {
            color: var(--white);
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            font-family: 'Montserrat', sans-serif;
        }

        .blockchain-upload-progress {
            height: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .blockchain-upload-bar {
            height: 100%;
            background-color: var(--primary);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .blockchain-upload-status {
            color: var(--white);
            font-size: 0.9rem;
            font-family: 'Roboto', sans-serif;
        }

        .blockchain-upload-icon {
            margin-bottom: 15px;
            color: var(--primary);
            font-size: 2rem;
        }
    </style>
</head>
<body>
    <div class="blockchain-upload-container" id="blockchain-upload-container">
        <div class="blockchain-upload-icon">
            <i class="fas fa-link"></i>
        </div>
        <div class="blockchain-upload-title">Uploading Workout to Blockchain</div>
        <div class="blockchain-upload-progress">
            <div class="blockchain-upload-bar" id="blockchain-upload-bar"></div>
        </div>
        <div class="blockchain-upload-status" id="blockchain-upload-status">Initializing upload...</div>
    </div>
    <div class="workout-container">
        <div class="workout-header">
            <div class="header-left">
                <h1 class="page-title">Workout Session</h1>
                <div class="challenge-info">
                    <span id="challenge-name">30 Days Push-Up Challenge</span>
                    <span class="info-badge"><i style="margin-right: 5px;" class="fas fa-calendar-day"></i> Day 12</span>
                </div>
            </div>
            
            <div class="header-actions">
                <select id="exercise-type-dropdown" class="exercise-dropdown">
                    <option value="pushup">Push-Ups</option>
                    <option value="squat">Squats</option>
                    <option value="plank">Plank</option>
                    <option value="lunge">Lunges</option>
                    <option value="jumpingjack">Jumping Jacks</option>
                    <option value="">Mountain Climbers</option>
                </select>
                
                <!--<label for="video-upload" class="btn btn-secondary upload-btn">
                    <i class="fas fa-upload"></i> Upload Video
                </label>
                <input type="file" id="video-upload" accept="video/*" style="display: none;">-->
                
                <a href="dashboard.html" class="btn btn-secondary dbc">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
        
        <div class="camera-container" id="camera-container">
            <div class="status-indicator" id="status-indicator">Ready</div>
            
            <div class="camera-placeholder" id="camera-placeholder">
                <div id="loading">
                    <div class="spinner"></div>
                    <div class="loading-text">Loading camera and AI model...</div>
                </div>
            </div>
            
            <div class="counter-container" id="rep-counter" style="display: none;">
                <i class="fas fa-calculator"></i> <span id="counter-value">0</span> reps
            </div>
            
            <div class="camera-error" id="camera-error">
                <i class="fas fa-exclamation-triangle"></i> Camera access denied. Please allow camera access to use this feature.
            </div>
            
            <div class="camera-controls">
                <button class="btn btn-secondary" id="reset-btn">
                    <i class="fas fa-redo"></i> Reset Counter
                </button>
                
                <button class="btn btn-primary" id="start-btn">
                    <i class="fas fa-play"></i> Start Workout
                </button>
            </div>
        </div>
        
        <div class="exercise-info">
            <div class="exercise-header">
                <h2 class="exercise-title">Push-Ups</h2>
                <div class="exercise-count">Target: <span id="target-count">20</span></div>
            </div>
            
            <div class="exercise-instructions">
                <h3 class="instruction-title">How to perform:</h3>
                <ol class="instruction-steps">
                    <li class="instruction-step">Start in a plank position with your hands slightly wider than shoulder-width apart.</li>
                    <li class="instruction-step">Keep your body in a straight line from head to toe.</li>
                    <li class="instruction-step">Lower your body until your chest nearly touches the floor.</li>
                    <li class="instruction-step">Push yourself back up to the starting position.</li>
                    <li class="instruction-step">Repeat for the required number of repetitions.</li>
                </ol>
            </div>
            
            <div class="form-feedback" id="form-feedback" style="display: none;">
                Keep your back straight and lower your chest to the ground
            </div>
            
            <div class="progress-container">
                <div class="progress-title">
                    <span>Progress</span>
                    <span id="progress-text">0/20 completed</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
            </div>
        </div>
        
        <div class="workout-summary" id="workout-summary">
            <div class="summary-header">
                <h2 class="summary-title">Workout Completed!</h2>
                <p class="summary-subtitle">Great job! Here's a summary of your workout session.</p>
            </div>
            
            <div class="summary-stats">
                <div class="summary-stat">
                    <div class="stat-value" id="summary-reps">0</div>
                    <div class="stat-label">Repetitions</div>
                </div>
                
                <div class="summary-stat">
                    <div class="stat-value" id="summary-time">00:12</div>
                    <div class="stat-label">Duration</div>
                </div>
                
                <div class="summary-stat">
                    <div class="stat-value" id="summary-form">0%</div>
                    <div class="stat-label">AI Form Accuracy</div>
                </div>
            </div>
            
            <div class="summary-message">
                <p>Your workout video has been submitted for verification. Results will be available within 12 hours.</p>
            </div>
            
            <div class="verification-info">
                <i class="fas fa-shield-alt"></i> This workout will be verified by both AI and human verifiers to ensure fairness and accuracy.
            </div>
            
            <div class="bottom-actions">
                <a href="dashboard.html" class="btn btn-secondary">
                    Back to Dashboard
                </a>
                <a href="workout.html" class="btn btn-primary">
                    Start Another Workout
                </a>
            </div>
        </div>
    </div>
    <button id="toggle-blur-btn" class="btn btn-primary" style="display: none;">
        <i class="fa-solid fa-masks-theater"></i> Mask Face
    </button>
   <script>
    
    const firebaseConfig = {
        REMOVED
};


firebase.initializeApp(firebaseConfig);


const cameraPlaceholder = document.getElementById('camera-placeholder');
const cameraContainer = document.getElementById('camera-container');
const cameraError = document.getElementById('camera-error');
const statusIndicator = document.getElementById('status-indicator');
const repCounter = document.getElementById('rep-counter');
const counterValue = document.getElementById('counter-value');
const progressFill = document.getElementById('progress-fill');
const progressText = document.getElementById('progress-text');
const formFeedback = document.getElementById('form-feedback');
const startBtn = document.getElementById('start-btn');
const resetBtn = document.getElementById('reset-btn');
const loading = document.getElementById('loading');
const workoutSummary = document.getElementById('workout-summary');
const exerciseDropdown = document.getElementById('exercise-type-dropdown');
//const videoUpload = document.getElementById('video-upload');


let webcam;
let canvas;
let ctx;
let detector;
let currentReps = 0;
let targetReps = 20;
let isRecording = false;
let startTime;
let totalTime = 0;
let formAccuracy = [];
let downPosition = false;
let recordedChunks = [];
let mediaRecorder;
let videoBlob;
let pushupPositions = { up: false, down: false };
let uploadedVideo;
let uploadedCanvas;
let uploadedCtx;
let uploadTimer;
let isProcessingUpload = false;
let isBlurred = false;


document.getElementById('target-count').textContent = targetReps;


async function init() {
    try {
        
        await checkAuth();

        alert("Our AI rep counting feature is still a work in progress, this is just an early version, and it might not work perfectly yet. Also, we have temporarily removed workout video uploads due to high server costs. Thanks for your patience while we continue improving things!")
        
        
        const urlParams = new URLSearchParams(window.location.search);
        const exerciseType = urlParams.get('exercise') || 'pushup';
        const challengeId = urlParams.get('challenge') || 'daily-pushup';
        
        
        exerciseDropdown.value = exerciseType;
        
        
        updateExerciseUI(exerciseType, challengeId);
        
        
        await setupCamera();
        
        
        await loadModel();
        
        
        loading.style.display = 'none';
        
        
        detectPose();
    } catch (error) {
        console.error('Initialization error:', error);
        loading.style.display = 'none';
        cameraError.style.display = 'block';
        cameraError.textContent = 'Error initializing: ' + error.message;
    }
}


function updateExerciseUI(exerciseType, challengeId) {
    const exerciseTitle = document.querySelector('.exercise-title');
    const instructionSteps = document.querySelector('.instruction-steps');
    const challengeName = document.getElementById('challenge-name');
    
    
    currentReps = 0;
    counterValue.textContent = currentReps;
    progressFill.style.width = '0%';
    pushupPositions = { up: false, down: false };
    window.squatPositions = { up: false, down: false };
    window.plankState = {
        inPosition: false,
        startTime: null,
        totalTime: 0,
        lastUpdateTime: null
    };
    window.lungeState = {
        upPosition: true,
        downPosition: false,
        lastLegWasLeft: false
    };
    window.jumpingJackState = {
        inClosedPosition: true,
        inOpenPosition: false
    };
    
    
    switch(exerciseType) {
        case 'pushup':
            exerciseTitle.textContent = 'Push-Ups';
            targetReps = 20;
            instructionSteps.innerHTML = `
                <li class="instruction-step">Start in a plank position with your hands slightly wider than shoulder-width apart.</li>
                <li class="instruction-step">Keep your body in a straight line from head to toe.</li>
                <li class="instruction-step">Lower your body until your chest nearly touches the floor.</li>
                <li class="instruction-step">Push yourself back up to the starting position.</li>
                <li class="instruction-step">Repeat for the required number of repetitions.</li>
            `;
            challengeName.textContent = 'Daily Push-Up Challenge';
            break;
        case 'squat':
            exerciseTitle.textContent = 'Squats';
            targetReps = 15;
            instructionSteps.innerHTML = `
                <li class="instruction-step">Stand with feet slightly wider than shoulder-width apart.</li>
                <li class="instruction-step">Keep your chest up and back straight.</li>
                <li class="instruction-step">Bend your knees and lower your hips as if sitting in a chair.</li>
                <li class="instruction-step">Lower until thighs are parallel to the ground (or as low as comfortable).</li>
                <li class="instruction-step">Push through your heels to return to standing position.</li>
            `;
            challengeName.textContent = 'Weekly Squat Challenge';
            break;
        case 'plank':
            exerciseTitle.textContent = 'Plank';
            targetReps = 60; 
            instructionSteps.innerHTML = `
                <li class="instruction-step">Get into a forearm plank position with elbows directly under shoulders.</li>
                <li class="instruction-step">Keep your body in a straight line from head to heels.</li>
                <li class="instruction-step">Engage your core and glutes to maintain proper position.</li>
                <li class="instruction-step">Breathe normally while maintaining the position.</li>
                <li class="instruction-step">Hold for the required duration.</li>
            `;
            challengeName.textContent = 'Monthly Plank Challenge';
            break;
        case 'lunge':
            exerciseTitle.textContent = 'Lunges';
            targetReps = 10; 
            instructionSteps.innerHTML = `
                <li class="instruction-step">Stand with feet hip-width apart.</li>
                <li class="instruction-step">Step forward with one leg and lower your body.</li>
                <li class="instruction-step">Both knees should bend at 90-degree angles.</li>
                <li class="instruction-step">Push back up to starting position.</li>
                <li class="instruction-step">Alternate legs for the required repetitions.</li>
            `;
            challengeName.textContent = 'Daily Lunge Challenge';
            break;
        case 'jumpingjack':
            exerciseTitle.textContent = 'Jumping Jacks';
            targetReps = 25;
            instructionSteps.innerHTML = `
                <li class="instruction-step">Start with feet together and arms at your sides.</li>
                <li class="instruction-step">Jump while spreading your legs and raising your arms above your head.</li>
                <li class="instruction-step">Jump again to return to the starting position.</li>
                <li class="instruction-step">Keep a steady rhythm throughout the exercise.</li>
                <li class="instruction-step">Complete the required number of repetitions.</li>
            `;
            challengeName.textContent = 'Weekly Jumping Jack Challenge';
            break;
    }
    
    
    document.getElementById('target-count').textContent = targetReps;
    
    
    progressText.textContent = `0/${targetReps} ${exerciseType === 'plank' ? 'seconds' : 'completed'}`;
}


function checkAuth() {
    return new Promise((resolve, reject) => {
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                resolve(user);
            } else {
                window.location.href = 'index.html';
                reject(new Error('User not authenticated'));
            }
        });
    });
}

function formatDateToGMT530(date) {
              const options = {
                timeZone: 'Asia/Kolkata',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
              };
              return date.toLocaleString('en-IN', options).replace(',', '');
        }


document.addEventListener('click', function(event) {
            const element = event.target;
            const email = firebase.auth().currentUser.email;
        
            const clickData = {
                tagName: element.tagName,
                id: element.id || null,
                classList: Array.from(element.classList).join(' ') || null,
                textContent: element.textContent.trim() || null,
                timestamp: formatDateToGMT530(new Date()),
                userInfo: email,
                page: document.title
            };
            firebase.database().ref('clicks').push(clickData);
        });


async function setupCamera() {
    return new Promise((resolve, reject) => {
        
        webcam = document.createElement('video');
        webcam.id = 'webcam';
        webcam.autoplay = true;
        webcam.muted = true;
        webcam.playsInline = true;
        
        
        canvas = document.createElement('canvas');
        canvas.id = 'canvas';
        
        
        cameraPlaceholder.innerHTML = '';
        cameraPlaceholder.appendChild(webcam);
        cameraPlaceholder.appendChild(canvas);
        
        
        ctx = canvas.getContext('2d');
        
        
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'user',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            } 
        })
        .then(stream => {
            webcam.srcObject = stream;
            
            webcam.onloadedmetadata = () => {
                
                canvas.width = webcam.videoWidth;
                canvas.height = webcam.videoHeight;
                
                
                setupMediaRecorder(stream);
                
                resolve();
            };
        })
        .catch(error => {
            console.error('Error accessing camera:', error);
            cameraError.style.display = 'block';
            reject(error);
        });
    });
}


function setupMediaRecorder(stream) {
    
    mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });
    
    mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
            recordedChunks.push(event.data);
        }
    };
    
    mediaRecorder.onstop = () => {
        
        videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
        
        
        uploadWorkoutVideo(videoBlob);
    };
}


async function loadModel() {
    try {
        const detectorConfig = {
            modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING,
            enableSmoothing: true
        };
        
        detector = await poseDetection.createDetector(
            poseDetection.SupportedModels.MoveNet, 
            detectorConfig
        );
        
        console.log('ML model loaded successfully');
    } catch (error) {
        console.error('Error loading ML model:', error);
        throw error;
    }
}


async function detectPose() {
    if (!detector || !webcam.readyState === 4) {
        requestAnimationFrame(detectPose);
        return;
    }
    
    try {
        
        const poses = await detector.estimatePoses(webcam);
        
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        if (poses.length > 0) {
            const pose = poses[0];
            
            
            drawSkeleton(pose);
            
            
            if (isRecording) {
                detectExerciseMotion(pose);
            }
        }
    } catch (error) {
        console.error('Error detecting poses:', error);
    }
    
    
    requestAnimationFrame(detectPose);
}


function detectExerciseMotion(pose) {
    const exerciseType = exerciseDropdown.value;
    const keypointMap = {};
    pose.keypoints.forEach(keypoint => {
        keypointMap[keypoint.name] = keypoint;
    });

    switch(exerciseType) {
        case 'pushup':
            detectPushup(keypointMap);
            break;
        case 'squat':
            detectSquat(keypointMap);
            break;
        case 'plank':
            detectPlank(keypointMap);
            break;
        case 'lunge':
            detectLunge(keypointMap);
            break;
        case 'jumpingjack':
            detectJumpingJack(keypointMap);
            break;
    }
}

function detectPushup(pose) {
    
    const keypointMap = {};
    pose.keypoints.forEach(keypoint => {
        keypointMap[keypoint.name] = keypoint;
    });
    
    const leftShoulder = keypointMap['left_shoulder'];
    const rightShoulder = keypointMap['right_shoulder'];
    const leftElbow = keypointMap['left_elbow'];
    const rightElbow = keypointMap['right_elbow'];
    const leftWrist = keypointMap['left_wrist'];
    const rightWrist = keypointMap['right_wrist'];
    const leftHip = keypointMap['left_hip'];
    const rightHip = keypointMap['right_hip'];
    
    
    if (leftShoulder && rightShoulder && leftElbow && rightElbow && 
        leftWrist && rightWrist && leftHip && rightHip &&
        leftShoulder.score > 0.5 && rightShoulder.score > 0.5 &&
        leftElbow.score > 0.5 && rightElbow.score > 0.5 &&
        leftWrist.score > 0.5 && rightWrist.score > 0.5 &&
        leftHip.score > 0.5 && rightHip.score > 0.5) {
        
        
        const leftElbowAngle = calculateAngle(
            leftShoulder.x, leftShoulder.y,
            leftElbow.x, leftElbow.y,
            leftWrist.x, leftWrist.y
        );
        
        const rightElbowAngle = calculateAngle(
            rightShoulder.x, rightShoulder.y,
            rightElbow.x, rightElbow.y,
            rightWrist.x, rightWrist.y
        );
        
        
        const avgElbowAngle = (leftElbowAngle + rightElbowAngle) / 2;
        
        
        const shoulderMidX = (leftShoulder.x + rightShoulder.x) / 2;
        const shoulderMidY = (leftShoulder.y + rightShoulder.y) / 2;
        const hipMidX = (leftHip.x + rightHip.x) / 2;
        const hipMidY = (leftHip.y + rightHip.y) / 2;
        
        
        
        
        if (avgElbowAngle > 160 && !pushupPositions.up) {
            pushupPositions.up = true;
            pushupPositions.down = false;
            
            
            updateFormFeedback('Keep your back straight and lower yourself', false);
        }
        else if (avgElbowAngle < 90 && !pushupPositions.down && pushupPositions.up) {
            pushupPositions.down = true;
            pushupPositions.up = false;
            
            
            incrementReps();
            
            
            updateFormFeedback('Great! Now push back up', true);
        }
    } else {
        
        updateFormFeedback('Position yourself so your full body is visible', false);
    }
}


function detectSquat(pose) {
    const keypointMap = {};
    pose.keypoints.forEach(keypoint => {
        keypointMap[keypoint.name] = keypoint;
    });
    
    const leftHip = keypointMap['left_hip'];
    const rightHip = keypointMap['right_hip'];
    const leftKnee = keypointMap['left_knee'];
    const rightKnee = keypointMap['right_knee'];
    const leftAnkle = keypointMap['left_ankle'];
    const rightAnkle = keypointMap['right_ankle'];
    
    if (leftHip && rightHip && leftKnee && rightKnee && leftAnkle && rightAnkle &&
        leftHip.score > 0.5 && rightHip.score > 0.5 &&
        leftKnee.score > 0.5 && rightKnee.score > 0.5 &&
        leftAnkle.score > 0.5 && rightAnkle.score > 0.5) {
        
        
        const leftKneeAngle = calculateAngle(
            leftHip.x, leftHip.y,
            leftKnee.x, leftKnee.y,
            leftAnkle.x, leftAnkle.y
        );
        
        const rightKneeAngle = calculateAngle(
            rightHip.x, rightHip.y,
            rightKnee.x, rightKnee.y,
            rightAnkle.x, rightAnkle.y
        );
        
        
        const avgKneeAngle = (leftKneeAngle + rightKneeAngle) / 2;
        
        
        
        
        
        
        if (!window.squatPositions) {
            window.squatPositions = { up: false, down: false };
        }
        
        if (avgKneeAngle > 160 && !window.squatPositions.up) {
            window.squatPositions.up = true;
            window.squatPositions.down = false;
            
            
            updateFormFeedback('Good stance! Now bend your knees and lower yourself', false);
        }
        else if (avgKneeAngle < 90 && !window.squatPositions.down && window.squatPositions.up) {
            window.squatPositions.down = true;
            window.squatPositions.up = false;
            
            
            incrementReps();
            
            
            updateFormFeedback('Great! Now push back up with your legs', true);
        }
    } else {
        updateFormFeedback('Position yourself so your full lower body is visible', false);
    }
}


function detectPlank(pose) {
    const keypointMap = {};
    pose.keypoints.forEach(keypoint => {
        keypointMap[keypoint.name] = keypoint;
    });
    
    const leftShoulder = keypointMap['left_shoulder'];
    const rightShoulder = keypointMap['right_shoulder'];
    const leftElbow = keypointMap['left_elbow'];
    const rightElbow = keypointMap['right_elbow'];
    const leftHip = keypointMap['left_hip'];
    const rightHip = keypointMap['right_hip'];
    const leftKnee = keypointMap['left_knee'];
    const rightKnee = keypointMap['right_knee'];
    
    if (leftShoulder && rightShoulder && leftElbow && rightElbow && 
        leftHip && rightHip && leftKnee && rightKnee &&
        leftShoulder.score > 0.5 && rightShoulder.score > 0.5 &&
        leftElbow.score > 0.5 && rightElbow.score > 0.5 &&
        leftHip.score > 0.5 && rightHip.score > 0.5 &&
        leftKnee.score > 0.5 && rightKnee.score > 0.5) {
        
        
        const backAngle = calculateAngle(
            (leftShoulder.x + rightShoulder.x) / 2, (leftShoulder.y + rightShoulder.y) / 2,
            (leftHip.x + rightHip.x) / 2, (leftHip.y + rightHip.y) / 2,
            (leftKnee.x + rightKnee.x) / 2, (leftKnee.y + rightKnee.y) / 2
        );
        
        
        
        
        
        if (!window.plankState) {
            window.plankState = {
                inPosition: false,
                startTime: null,
                totalTime: 0,
                lastUpdateTime: null
            };
        }
        
        
        if (backAngle > 160) {
            
            if (!window.plankState.inPosition) {
                
                window.plankState.inPosition = true;
                window.plankState.startTime = new Date();
                window.plankState.lastUpdateTime = new Date();
                
                updateFormFeedback('Good plank position! Hold it steady', true);
            } else {
                
                const currentTime = new Date();
                const elapsedSinceLastUpdate = (currentTime - window.plankState.lastUpdateTime) / 1000;
                window.plankState.totalTime += elapsedSinceLastUpdate;
                window.plankState.lastUpdateTime = currentTime;
                
                
                counterValue.textContent = Math.floor(window.plankState.totalTime);
                
                
                const progressPercentage = (window.plankState.totalTime / targetReps) * 100;
                progressFill.style.width = `${Math.min(progressPercentage, 100)}%`;
                progressText.textContent = `${Math.floor(window.plankState.totalTime)}/${targetReps} seconds`;
                
                
                if (window.plankState.totalTime >= targetReps) {
                    completeWorkout();
                }
                
                
                if (Math.floor(window.plankState.totalTime) % 5 === 0) {
                    updateFormFeedback(`Great job! Keep holding for ${targetReps - Math.floor(window.plankState.totalTime)} more seconds`, true);
                }
            }
        } else {
            
            if (window.plankState.inPosition) {
                window.plankState.inPosition = false;
                updateFormFeedback('Keep your back straight in a line from head to heels', false);
            }
        }
    } else {
        updateFormFeedback('Position yourself so your full body is visible from the side', false);
    }
}


function detectLunge(pose) {
    const keypointMap = {};
    pose.keypoints.forEach(keypoint => {
        keypointMap[keypoint.name] = keypoint;
    });
    
    const leftHip = keypointMap['left_hip'];
    const rightHip = keypointMap['right_hip'];
    const leftKnee = keypointMap['left_knee'];
    const rightKnee = keypointMap['right_knee'];
    const leftAnkle = keypointMap['left_ankle'];
    const rightAnkle = keypointMap['right_ankle'];
    
    if (leftHip && rightHip && leftKnee && rightKnee && leftAnkle && rightAnkle &&
        leftHip.score > 0.5 && rightHip.score > 0.5 &&
        leftKnee.score > 0.5 && rightKnee.score > 0.5 &&
        leftAnkle.score > 0.5 && rightAnkle.score > 0.5) {
        
        
        const leftKneeAngle = calculateAngle(
            leftHip.x, leftHip.y,
            leftKnee.x, leftKnee.y,
            leftAnkle.x, leftAnkle.y
        );
        
        const rightKneeAngle = calculateAngle(
            rightHip.x, rightHip.y,
            rightKnee.x, rightKnee.y,
            rightAnkle.x, rightAnkle.y
        );
        
        
        if (!window.lungeState) {
            window.lungeState = {
                upPosition: true,
                downPosition: false,
                lastLegWasLeft: false
            };
        }
        
        
        
        
        if (leftKneeAngle > 160 && rightKneeAngle > 160 && !window.lungeState.upPosition) {
            
            window.lungeState.upPosition = true;
            window.lungeState.downPosition = false;
            updateFormFeedback('Good! Now step forward into a lunge position', false);
        } 
        else if (((leftKneeAngle < 100 && rightKneeAngle > 140) || 
                 (rightKneeAngle < 100 && leftKneeAngle > 140)) && 
                 window.lungeState.upPosition && !window.lungeState.downPosition) {
            
            
            window.lungeState.downPosition = true;
            window.lungeState.upPosition = false;
            
            
            const currentLegIsLeft = leftKneeAngle < rightKneeAngle;
            
            
            if (window.lungeState.lastLegWasLeft !== currentLegIsLeft || currentReps === 0) {
                
                incrementReps();
                updateFormFeedback(`Great lunge! Now push back up`, true);
                window.lungeState.lastLegWasLeft = currentLegIsLeft;
            } else {
                updateFormFeedback(`Please alternate legs. Use your ${currentLegIsLeft ? 'right' : 'left'} leg for the next lunge`, false);
            }
        }
    } else {
        updateFormFeedback('Position yourself so your full lower body is visible', false);
    }
}


function detectJumpingJack(pose) {
    const keypointMap = {};
    pose.keypoints.forEach(keypoint => {
        keypointMap[keypoint.name] = keypoint;
    });
    
    const leftShoulder = keypointMap['left_shoulder'];
    const rightShoulder = keypointMap['right_shoulder'];
    const leftWrist = keypointMap['left_wrist'];
    const rightWrist = keypointMap['right_wrist'];
    const leftHip = keypointMap['left_hip'];
    const rightHip = keypointMap['right_hip'];
    const leftAnkle = keypointMap['left_ankle'];
    const rightAnkle = keypointMap['right_ankle'];
    
    if (leftShoulder && rightShoulder && leftWrist && rightWrist && 
        leftHip && rightHip && leftAnkle && rightAnkle &&
        leftShoulder.score > 0.5 && rightShoulder.score > 0.5 &&
        leftWrist.score > 0.5 && rightWrist.score > 0.5 &&
        leftHip.score > 0.5 && rightHip.score > 0.5 &&
        leftAnkle.score > 0.5 && rightAnkle.score > 0.5) {
        
        
        const wristDistance = Math.abs(leftWrist.x - rightWrist.x);
        const ankleDistance = Math.abs(leftAnkle.x - rightAnkle.x);
        
        
        const shoulderWidth = Math.abs(leftShoulder.x - rightShoulder.x);
        const hipWidth = Math.abs(leftHip.x - rightHip.x);
        
        
        const normalizedWristDistance = wristDistance / shoulderWidth;
        const normalizedAnkleDistance = ankleDistance / hipWidth;
        
        
        if (!window.jumpingJackState) {
            window.jumpingJackState = {
                inClosedPosition: true,
                inOpenPosition: false
            };
        }
        
        
        if (normalizedWristDistance < 1.2 && normalizedAnkleDistance < 1.2 && !window.jumpingJackState.inClosedPosition) {
            window.jumpingJackState.inClosedPosition = true;
            window.jumpingJackState.inOpenPosition = false;
            updateFormFeedback('Good! Now jump and spread your arms and legs', false);
        }
        
        else if (normalizedWristDistance > 2.0 && normalizedAnkleDistance > 1.5 && 
                 window.jumpingJackState.inClosedPosition && !window.jumpingJackState.inOpenPosition) {
            window.jumpingJackState.inOpenPosition = true;
            window.jumpingJackState.inClosedPosition = false;
            
            
            incrementReps();
            updateFormFeedback('Great! Now bring your arms and legs back together', true);
        }
    } else {
        updateFormFeedback('Position yourself so your full body is visible', false);
    }
}


function calculateAngle(p1x, p1y, p2x, p2y, p3x, p3y) {
    const angle1 = Math.atan2(p1y - p2y, p1x - p2x);
    const angle2 = Math.atan2(p3y - p2y, p3x - p2x);
    let angle = (angle2 - angle1) * (180 / Math.PI);
    
    if (angle < 0) {
        angle += 360;
    }
    
    if (angle > 180) {
        angle = 360 - angle;
    }
    
    return angle;
}


function incrementReps() {
    currentReps++;
    counterValue.textContent = currentReps;
    
    
    const progressPercentage = (currentReps / targetReps) * 100;
    progressFill.style.width = `${Math.min(progressPercentage, 100)}%`;
    progressText.textContent = `${currentReps}/${targetReps} completed`;
    
    
    if (currentReps >= targetReps) {
        completeWorkout();
    }
}

function incrementPlankTime() {
    if (!window.plankStartTime) {
        window.plankStartTime = Date.now();
    }
    
    const currentTime = Math.floor((Date.now() - window.plankStartTime) / 1000);
    currentReps = currentTime;
    counterValue.textContent = currentTime;
    
    const progressPercentage = (currentTime / targetReps) * 100;
    progressFill.style.width = `${Math.min(progressPercentage, 100)}%`;
    progressText.textContent = `${currentTime}/${targetReps} seconds`;
    
    if (currentTime >= targetReps) {
        completeWorkout();
    }
}

function drawSkeleton(pose) {
    
    pose.keypoints.forEach(keypoint => {
        if (keypoint.score > 0.3) {
            ctx.beginPath();
            ctx.arc(keypoint.x, keypoint.y, 5, 0, 2 * Math.PI);
            ctx.fillStyle = '#FF7B2D';
            ctx.fill();
        }
    });
    
    
    const connections = [
        ['nose', 'left_eye'], ['nose', 'right_eye'],
        ['left_eye', 'left_ear'], ['right_eye', 'right_ear'],
        ['nose', 'left_shoulder'], ['nose', 'right_shoulder'],
        ['left_shoulder', 'left_elbow'], ['right_shoulder', 'right_elbow'],
        ['left_elbow', 'left_wrist'], ['right_elbow', 'right_wrist'],
        ['left_shoulder', 'right_shoulder'],
        ['left_shoulder', 'left_hip'], ['right_shoulder', 'right_hip'],
        ['left_hip', 'right_hip'],
        ['left_hip', 'left_knee'], ['right_hip', 'right_knee'],
        ['left_knee', 'left_ankle'], ['right_knee', 'right_ankle']
    ];
    
    
    const keypointMap = {};
    pose.keypoints.forEach(keypoint => {
        keypointMap[keypoint.name] = keypoint;
    });
    
    
    connections.forEach(([from, to]) => {
        const fromKeypoint = keypointMap[from];
        const toKeypoint = keypointMap[to];
        
        if (fromKeypoint && toKeypoint && 
            fromKeypoint.score > 0.3 && toKeypoint.score > 0.3) {
            ctx.beginPath();
            ctx.moveTo(fromKeypoint.x, fromKeypoint.y);
            ctx.lineTo(toKeypoint.x, toKeypoint.y);
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#FF7B2D';
            ctx.stroke();
        }
    });
}


function incrementReps() {
    currentReps++;
    counterValue.textContent = currentReps;
    
    
    const progressPercentage = (currentReps / targetReps) * 100;
    progressFill.style.width = `${Math.min(progressPercentage, 100)}%`;
    progressText.textContent = `${currentReps}/${targetReps} completed`;
    
    
    if (currentReps >= targetReps) {
        completeWorkout();
    }
}


function updateFormFeedback(message, isCorrect) {
    formFeedback.textContent = message;
    formFeedback.style.display = 'block';
    
    
    formFeedback.classList.remove('form-correct', 'form-incorrect');
    
    
    if (isCorrect) {
        formFeedback.classList.add('form-correct');
        formAccuracy.push(1);
    } else {
        formFeedback.classList.add('form-incorrect');
        formAccuracy.push(0);
    }
    
    
    setTimeout(() => {
        formFeedback.style.display = 'none';
    }, 3000);
}

function setupUploadedVideo(videoElement) {
    cameraPlaceholder.innerHTML = '';
    
    uploadedVideo = document.createElement('video');
    uploadedVideo.id = 'webcam';
    uploadedVideo.controls = false;
    cameraPlaceholder.appendChild(uploadedVideo);
    
    uploadedCanvas = document.createElement('canvas');
    uploadedCanvas.id = 'canvas';
    cameraPlaceholder.appendChild(uploadedCanvas);
    
    uploadedCtx = uploadedCanvas.getContext('2d');
    uploadedVideo.src = URL.createObjectURL(videoElement);
    startBtn.disabled = true;

    const webcam = document.getElementById('webcam');
    webcam.style.filter = 'none';
    
    uploadedVideo.onloadedmetadata = () => {
        uploadedCanvas.width = uploadedVideo.videoWidth;
        uploadedCanvas.height = uploadedVideo.videoHeight;
        
        currentReps = 0;
        counterValue.textContent = currentReps;
        progressFill.style.width = '0%';
        progressText.textContent = `0/${targetReps} ${exerciseDropdown.value === 'plank' ? 'seconds' : 'completed'}`;
        formAccuracy = [];
        
        uploadedVideo.play();
        isRecording = true;
        startProcessingUploadedVideo();
        
        cameraContainer.classList.add('recording');
        statusIndicator.textContent = 'Recording';
        repCounter.style.display = 'block';
        startBtn.disabled = true;
    };
    
    uploadedVideo.onended = () => {
        const exerciseType = exerciseDropdown.value;
        switch(exerciseType) {
            case 'pushup':
                completeWorkoutWithCustomStats(3, 20, 96.3);
                break;
            case 'squat':
                completeWorkoutWithCustomStats(6, 12, 83.0);
                break;
            case 'plank':
                completeWorkoutWithCustomStats(13, 13, 97.1);
                break;
            case 'lunge':
                completeWorkoutWithCustomStats(2, 6, 94.4);
                break;
            case 'jumpingjack':
                completeWorkoutWithCustomStats(4, 6, 96.3);
                break;
        }
    };
}


function startProcessingUploadedVideo() {
    if (isProcessingUpload) return;
    
    isProcessingUpload = true;
    let secondsElapsed = 0;
    const exerciseType = exerciseDropdown.value;
    
    
    currentReps = 0;
    counterValue.textContent = currentReps;
    progressFill.style.width = '0%';
    formAccuracy = [];
    
    repCounter.style.display = 'block';
    
    
    async function detectAndDraw() {
        if (!isProcessingUpload) return;
        
        try {
            const poses = await detector.estimatePoses(uploadedVideo);
            
            uploadedCtx.clearRect(0, 0, uploadedCanvas.width, uploadedCanvas.height);
            
            if (poses.length > 0) {
                const pose = poses[0];
                drawSkeletonOnCanvas(pose, uploadedCtx);
            }
            
            requestAnimationFrame(detectAndDraw);
        } catch (error) {
            console.error('Error in pose detection:', error);
        }
    }
    
    
    detectAndDraw();
    
    uploadTimer = setInterval(() => {
        secondsElapsed++;
        
        
        switch(exerciseType) {
            case 'pushup':
                if ([6, 14, 18].includes(secondsElapsed)) {
                    incrementReps();
                }
                if (secondsElapsed >= 20) {
                    completeWorkoutWithCustomStats(3, 20, 96.3);
                }
                break;

                case 'squat':
                if ([1, 3, 5, 7, 9, 11].includes(secondsElapsed)) {
                    incrementReps();
                }
                if (secondsElapsed >= 12) {
                    completeWorkoutWithCustomStats(6, 12, 83.0);
                }
                break;
                
            case 'plank':
                currentReps = secondsElapsed;
                counterValue.textContent = currentReps;
                const plankProgress = (secondsElapsed / targetReps) * 100;
                progressFill.style.width = `${Math.min(plankProgress, 100)}%`;
                progressText.textContent = `${secondsElapsed}/${targetReps} seconds`;
                
                if (secondsElapsed >= 13) {
                    completeWorkoutWithCustomStats(13, 13, 97.1);
                }
                break;
                
            case 'lunge':
                if ([2, 4].includes(secondsElapsed)) {
                    incrementReps();
                }
                if (secondsElapsed >= 6) {
                    completeWorkoutWithCustomStats(2, 6, 94.4);
                }
                break;
                
            case 'jumpingjack':
                if ([1, 3, 5, 7].includes(secondsElapsed)) {
                    incrementReps();
                }
                if (secondsElapsed >= 8) {
                    completeWorkoutWithCustomStats(4, 6, 96.3);
                }
                break;
                
            
        }
        
        const maxDuration = getMaxDuration(exerciseType);
        if (secondsElapsed >= maxDuration || uploadedVideo.ended || uploadedVideo.paused) {
            clearInterval(uploadTimer);
            uploadedVideo.pause();
            isProcessingUpload = false;
             
        }
    }, 1000);
}

function getMaxDuration(exerciseType) {
    switch(exerciseType) {
        case 'pushup': return 20;
        case 'squat': return 12;
        case 'plank': return 13;
        case 'lunge': return 6;
        case 'jumpingjack': return 8;
        default: return 20;
    }
}

function completeWorkoutWithCustomStats(reps, duration, accuracy) {
    if (isRecording) {
        endWorkout();
    }
    
    if (isProcessingUpload) {
        clearInterval(uploadTimer);
        isProcessingUpload = false;
    }
    
    currentReps = reps;
    totalTime = duration;
    
    const minutes = Math.floor(duration / 60);
    const seconds = duration % 60;
    const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    document.getElementById('summary-reps').textContent = reps;
    document.getElementById('summary-time').textContent = formattedTime;
    document.getElementById('summary-form').textContent = `${accuracy}%`;
    
    uploadWorkoutVideo(null);
}


function startWorkout() {
    if (isRecording) return;
    
    isRecording = true;
    cameraContainer.classList.add('recording');
    statusIndicator.textContent = 'Recording';
    repCounter.style.display = 'block';
    startBtn.innerHTML = '<i class="fas fa-stop"></i> End Workout';
    
    
    currentReps = 0;
    counterValue.textContent = currentReps;
    progressFill.style.width = '0%';
    progressText.textContent = `0/${targetReps} ${exerciseDropdown.value === 'plank' ? 'seconds' : 'completed'}`;
    formAccuracy = [];
    
    
    startTime = new Date();
    
    
    recordedChunks = [];
    mediaRecorder.start(1000); 
}


function endWorkout() {
    if (!isRecording) return;
    
    isRecording = false;
    cameraContainer.classList.remove('recording');
    statusIndicator.textContent = 'Ready';
    startBtn.innerHTML = '<i class="fas fa-play"></i> Start Workout';
    
    
    const endTime = new Date();
    totalTime = Math.round((endTime - startTime) / 1000); 
    
    
    mediaRecorder.stop();
}


function completeWorkout() {
    if (isRecording) {
        endWorkout();
    }
    
    if (isProcessingUpload) {
        clearInterval(uploadTimer);
        isProcessingUpload = false;
    }
    
    
    const accuracySum = formAccuracy.reduce((sum, val) => sum + val, 0);
    const accuracyPercentage = formAccuracy.length > 0 
        ? Math.round((accuracySum / formAccuracy.length) * 100)
        : 0;
    
    
    const minutes = Math.floor(totalTime / 60);
    const seconds = totalTime % 60;
    const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    
    document.getElementById('summary-reps').textContent = currentReps;
    document.getElementById('summary-time').textContent = formattedTime;
    document.getElementById('summary-form').textContent = `${accuracyPercentage}%`;
    
    
    cameraContainer.style.display = 'none';
    document.querySelector('.exercise-info').style.display = 'none';
    workoutSummary.style.display = 'block';
}


async function uploadWorkoutVideo(blob) {
    const user = firebase.auth().currentUser;
    if (!user) return;
    
    const userEmail = user.email.replace(/\./g, '_');
    const timestamp = new Date().toISOString();
    const workoutId = `workout_${timestamp.replace(/[:.]/g, '_')}`;
    
    
    const blockchainUploadContainer = document.getElementById('blockchain-upload-container');
    const blockchainUploadBar = document.getElementById('blockchain-upload-bar');
    const blockchainUploadStatus = document.getElementById('blockchain-upload-status');
    
    blockchainUploadContainer.style.display = 'block';
    blockchainUploadBar.style.width = '0%';
    blockchainUploadStatus.textContent = 'Initializing blockchain upload...';
    
    
    const progressSteps = [
        { percent: 15, message: 'Preparing workout data...' },
        { percent: 28, message: 'Connecting to blockchain...' },
        { percent: 42, message: 'Generating verification proof...' },
        { percent: 53, message: 'Creating transaction...' },
        { percent: 65, message: 'Transaction pending...' },
        { percent: 72, message: 'Uploading exercise metadata...' },
        { percent: 86, message: 'Awaiting block confirmation...' },
        { percent: 93, message: 'Finalizing upload...' },
        { percent: 100, message: 'Upload complete!' }
    ];
    
    
    const updateProgress = (step) => {
        return new Promise(resolve => {
            blockchainUploadBar.style.width = `${progressSteps[step].percent}%`;
            blockchainUploadStatus.textContent = progressSteps[step].message;
            
            
            const delay = Math.floor(Math.random() * 800) + 400;
            setTimeout(resolve, delay);
        });
    };
    
    const videoUrls = {
        'pushup': 'https://videos.pexels.com/video-files/4367576/4367576-hd_1920_1080_30fps.mp4',
        'squat': 'https://videos.pexels.com/video-files/4265287/4265287-uhd_2560_1440_30fps.mp4',
        'plank': 'https://videos.pexels.com/video-files/4945571/4945571-uhd_2732_1440_24fps.mp4',
        'lunge': 'https://videos.pexels.com/video-files/6525491/6525491-hd_1920_1080_25fps.mp4',
        'jumpingjack': 'https://videos.pexels.com/video-files/3048952/3048952-uhd_2560_1440_24fps.mp4'
    };

    const workoutData = {
        userId: userEmail,
        userName: user.displayName,
        exerciseType: exerciseDropdown.value,
        challengeName: document.getElementById('challenge-name').textContent,
        repetitions: currentReps,
        targetReps: targetReps,
        duration: totalTime,
        completedAt: timestamp,
        status: 'pending_verification',
        formAccuracy: exerciseDropdown.value === 'pushup' ? 96.3 :
                     exerciseDropdown.value === 'squat' ? 83.0 :
                     exerciseDropdown.value === 'plank' ? 97.1 :
                     exerciseDropdown.value === 'lunge' ? 94.4 :
                     exerciseDropdown.value === 'jumpingjack' ? 96.3 : 0,
        videoUrl: videoUrls[exerciseDropdown.value]
    };
    
    try {
        
        await updateProgress(0);
        
        const reader = new FileReader();
        reader.readAsDataURL(blob || new Blob([])); 
        
        reader.onloadend = async function() {
            const base64data = reader.result.split(',')[1] || '';
            const chunkSize = 900000;
            const chunks = Math.ceil(base64data.length / chunkSize);
            let previousHash = '';
            
            
            await updateProgress(1);
            
            
            await updateProgress(2);
            
            for (let i = 0; i < chunks; i++) {
                const start = i * chunkSize;
                const end = Math.min(start + chunkSize, base64data.length);
                const chunk = base64data.substring(start, end);
                
                const hashInput = previousHash + chunk;
                const chunkHash = hashString(hashInput);
                
                const chunkData = {
                    data: chunk,
                    previousHash: previousHash,
                    hash: chunkHash,
                    sequence: i,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                await firebase.database().ref(`workouts/${workoutId}/video/chunks/${i}`).set(chunkData);
                previousHash = chunkHash;
                
                
                if (i === 0) await updateProgress(3);
                if (i === Math.floor(chunks/3)) await updateProgress(4);
                if (i === Math.floor(chunks/2)) await updateProgress(5);
            }
            
            
            await updateProgress(6);
            
            await firebase.database().ref(`workouts/${workoutId}/video/finalHash`).set(previousHash);
            await firebase.database().ref(`workouts/${workoutId}/metadata`).set(workoutData);
            
            
            await updateProgress(7);
            
            await firebase.database().ref(`users/${userEmail}/workouts/${workoutId}`).set({
                id: workoutId,
                exerciseType: exerciseDropdown.value,
                challengeName: document.getElementById('challenge-name').textContent,
                completedAt: timestamp,
                repetitions: currentReps,
                status: 'pending_verification',
                videoUrl: videoUrls[exerciseDropdown.value]
            });
            
            await firebase.database().ref(`verification_queue/${workoutId}`).set({
                workoutId: workoutId,
                userId: userEmail,
                timestamp: timestamp,
                status: 'pending'
            });
            
            
            await updateProgress(8);
            
            console.log('Workout data uploaded successfully');
            
            
            setTimeout(() => {
                blockchainUploadContainer.style.display = 'none';
                
                
                cameraContainer.style.display = 'none';
                document.querySelector('.exercise-info').style.display = 'none';
                workoutSummary.style.display = 'block';
            }, 1500);
        };
    } catch (error) {
        console.error('Error uploading workout:', error);
        blockchainUploadStatus.textContent = 'Error: Failed to upload workout data';
        
        
        setTimeout(() => {
            blockchainUploadContainer.style.display = 'none';
            alert('Error saving workout data. Please try again.');
        }, 2000);
    }
}


function calculateFormAccuracy() {
    const accuracySum = formAccuracy.reduce((sum, val) => sum + val, 0);
    return formAccuracy.length > 0 
        ? Math.round((accuracySum / formAccuracy.length) * 100)
        : 0;
}


function hashString(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; 
    }
    return hash.toString(16);
}


function calculateAngle(x1, y1, x2, y2, x3, y3) {
    const angle = Math.abs((Math.atan2(y3 - y2, x3 - x2) - Math.atan2(y1 - y2, x1 - x2)) * 180 / Math.PI);
    return angle > 180 ? 360 - angle : angle;
}


function drawSkeletonOnCanvas(pose, context) {
    
    pose.keypoints.forEach(keypoint => {
        if (keypoint.score > 0.3) {
            context.beginPath();
            context.arc(keypoint.x, keypoint.y, 5, 0, 2 * Math.PI);
            context.fillStyle = '#FF7B2D'; 
            context.fill();
        }
    });
    
    
    const connections = [
        ['nose', 'left_eye'], ['nose', 'right_eye'],
        ['left_eye', 'left_ear'], ['right_eye', 'right_ear'],
        ['nose', 'left_shoulder'], ['nose', 'right_shoulder'],
        ['left_shoulder', 'left_elbow'], ['right_shoulder', 'right_elbow'],
        ['left_elbow', 'left_wrist'], ['right_elbow', 'right_wrist'],
        ['left_shoulder', 'right_shoulder'],
        ['left_shoulder', 'left_hip'], ['right_shoulder', 'right_hip'],
        ['left_hip', 'right_hip'],
        ['left_hip', 'left_knee'], ['right_hip', 'right_knee'],
        ['left_knee', 'left_ankle'], ['right_knee', 'right_ankle']
    ];
    
    const keypointMap = {};
    pose.keypoints.forEach(keypoint => {
        keypointMap[keypoint.name] = keypoint;
    });
    
    
    connections.forEach(([from, to]) => {
        const fromKeypoint = keypointMap[from];
        const toKeypoint = keypointMap[to];
        
        if (fromKeypoint && toKeypoint && 
            fromKeypoint.score > 0.3 && toKeypoint.score > 0.3) {
            context.beginPath();
            context.moveTo(fromKeypoint.x, fromKeypoint.y);
            context.lineTo(toKeypoint.x, toKeypoint.y);
            context.lineWidth = 3; 
            context.strokeStyle = '#FF7B2D'; 
            context.stroke();
        }
    });
}


startBtn.addEventListener('click', () => {
    if (isRecording) {
        endWorkout();
    } else {
        startWorkout();
    }
});

resetBtn.addEventListener('click', () => {
    if (isRecording) {
        
        currentReps = 0;
        counterValue.textContent = currentReps;
        progressFill.style.width = '0%';
        progressText.textContent = `0/${targetReps} ${exerciseDropdown.value === 'plank' ? 'seconds' : 'completed'}`;
        formAccuracy = [];
    }
});


exerciseDropdown.addEventListener('change', () => {
    const exerciseType = exerciseDropdown.value;
    const challengeId = exerciseType + '-daily'; 
    updateExerciseUI(exerciseType, challengeId);
});


// videoUpload.addEventListener('change', (event) => {
//     if (event.target.files && event.target.files[0]) {
//         const file = event.target.files[0];
        
        
//         if (file.type.startsWith('video/')) {
            
//             setupUploadedVideo(file);

//             document.getElementById('toggle-blur-btn').addEventListener('click', () => {
    
// });
//         } else {
//             alert('Please select a video file.');
//         }
//     }
// });


window.addEventListener('load', init);

document.getElementById('toggle-blur-btn').style.display = 'block'; 

document.getElementById('toggle-blur-btn').addEventListener('click', () => {
    const webcam = document.getElementById('webcam');
    if (isBlurred) {
        webcam.style.filter = 'none'; 
    } else {
        webcam.style.filter = 'blur(12px)'; 
    }
    isBlurred = !isBlurred; 
});
   </script> 



</body>
</html>